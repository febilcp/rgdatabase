<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa Master Portal - Final</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        /* --- GENERAL STYLES --- */
        body { font-family: 'Poppins', sans-serif; background-color: #f3f4f6; margin: 0; padding: 0; color: #333; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        
        /* --- MASTER NAV --- */
        #master-nav {
            background: white; padding: 0 20px; height: 70px; display: flex; align-items: center; justify-content: space-between;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 50;
        }
        .nav-tabs { display: flex; gap: 10px; background: #e2e8f0; padding: 5px; border-radius: 30px; }
        .nav-tab {
            padding: 10px 25px; border-radius: 25px; border: none; background: transparent; font-weight: 600; color: #64748b; cursor: pointer; transition: 0.3s;
        }
        .nav-tab.active { background: #1e3a5f; color: white; shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .logout-btn { background: #fee2e2; color: #ef4444; border: none; padding: 8px 16px; border-radius: 6px; font-weight: bold; cursor: pointer; }

        /* --- LOGIN --- */
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3a5f 0%, #764ba2 100%);
            display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .login-box { background: white; padding: 40px; border-radius: 15px; text-align: center; width: 350px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .login-input { width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .login-btn { width: 100%; padding: 12px; background: #1e3a5f; color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        
        /* Password Eye Icon Style */
        .password-wrapper { position: relative; width: 100%; }
        .password-wrapper i { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #666; }

        /* --- SHARED COMPONENTS --- */
        .stat-card {
            background: white; border-radius: 10px; padding: 20px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-left: 5px solid #ccc; cursor: pointer; transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-icon { width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: white; }
        
        /* Table Styles */
        .table-container { background: white; border-radius: 10px; overflow-x: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #1e3a5f; color: white; padding: 12px 15px; text-align: left; font-size: 0.85rem; white-space: nowrap; }
        td { padding: 12px 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; }
        tr:hover { background: #f8fafc; }

        /* Badge Styles */
        .badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
        .badge-pending { background: #fef3c7; color: #d97706; }
        .badge-completed { background: #d1fae5; color: #059669; }
        .badge-progress { background: #e0e7ff; color: #4f46e5; }

        /* Specific Colors for System Pending (App 1) */
        .sys-blue { border-left-color: #3b82f6; background: #eff6ff; }
        .sys-yellow { border-left-color: #eab308; background: #fefce8; }
        .sys-green { border-left-color: #22c55e; background: #f0fdf4; }
        .sys-cyan { border-left-color: #06b6d4; background: #ecfeff; }
        .sys-purple { border-left-color: #a855f7; background: #faf5ff; }
        .sys-gray { border-left-color: #6b7280; background: #f3f4f6; }

        /* Card Styles (App 2) */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .villa-card { background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .card-header { padding: 15px; color: white; font-weight: bold; display: flex; justify-content: space-between; }
        .card-body { padding: 15px; }
        .card-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; border-bottom: 1px dashed #eee; padding-bottom: 5px; }

        /* Export Button Style */
        .export-btn {
            background: #10b981; color: white; padding: 10px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer;
            display: inline-flex; align-items: center; gap: 8px; transition: background 0.2s;
        }
        .export-btn:hover { background: #059669; }

    </style>
</head>
<body>

    <!-- LOGIN -->
    <div id="login-overlay">
        <div class="login-box">
            <h2 style="margin-top:0;">Villa Master Portal</h2>
            <p style="color:#666; font-size: 0.9rem;">Secure Access</p>
            <form onsubmit="handleLogin(event)">
                <div class="password-wrapper">
                    <input type="password" id="masterPassword" class="login-input" placeholder="Enter Password" required>
                    <i class="fas fa-eye" id="togglePassword" onclick="togglePasswordVisibility()"></i>
                </div>
                <button type="submit" class="login-btn">LOGIN</button>
            </form>
            <p id="loginError" style="color:red; display:none; margin-top:10px;">Incorrect Password</p>
        </div>
    </div>

    <!-- MAIN NAV -->
    <nav id="master-nav" class="hidden">
        <div style="font-weight: bold; font-size: 1.2rem; color: #1e3a5f;">Villa Master Portal</div>
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchMainTab('tickets')">Maintenance Tickets</button>
            <button class="nav-tab" onclick="switchMainTab('compound')">Compound & AC</button>
        </div>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </nav>

    <!-- CONTAINER -->
    <div style="max-width: 1400px; margin: 30px auto; padding: 0 20px;">

        <!-- APP 1: TICKETS -->
        <div id="app-tickets">
            <!-- Ticket Header -->
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                <div>
                    <h2 style="margin:0; color: #1e3a5f;">Maintenance Dashboard</h2>
                    <p style="margin:5px 0 0; color: #666; font-size: 0.9rem;">Year: <span id="currentYearDisplay" style="font-weight:bold; color:#3b82f6;">2026</span></p>
                </div>
                <div style="display:flex; gap:10px;">
                    <select id="yearSelect" onchange="switchTicketYear(this.value)" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                        <!-- Filled by JS -->
                    </select>
                    <button onclick="resetTicketDashboard()" style="background: #8b5cf6; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">üè† Home</button>
                    <button onclick="loadTicketData()" style="background: #3b82f6; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer;">Refresh</button>
                    <!-- EXPORT TICKETS -->
                    <button onclick="exportTicketData()" class="export-btn"><i class="fas fa-file-excel"></i> Export</button>
                </div>
            </div>

            <!-- Ticket Stats -->
            <div id="ticketStatsArea" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px;">
                <!-- Filled by JS -->
            </div>

            <!-- Pending by System -->
            <div id="systemPendingArea" style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-top: 20px;">
                <h3 style="margin-top:0; color: #1e3a5f;">‚öôÔ∏è Pending Work by System</h3>
                <div id="systemGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px;">
                    <!-- Filled by JS -->
                </div>
            </div>

            <!-- Filters -->
            <div style="background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-top: 20px;">
                <h3 style="margin-top:0;">üîç Search & Filter</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                    <input type="text" id="mrfInput" placeholder="MRF No" class="login-input" style="margin:0;">
                    <input type="text" id="villaInput" placeholder="Villa/Flat" class="login-input" style="margin:0;">
                    <select id="systemInput" class="login-input" style="margin:0;"><option value="">All Systems</option></select>
                    <select id="statusInput" class="login-input" style="margin:0;">
                        <option value="">All Status</option><option value="pending">Pending</option><option value="progress">In Progress</option><option value="completed">Completed</option>
                    </select>
                    <input type="text" id="detailsInput" placeholder="Search Details" class="login-input" style="margin:0;">
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px;">
                    <button onclick="applyTicketFilters()" style="background: #1e3a5f; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer;">Search</button>
                    <button onclick="resetTicketDashboard()" id="clearBtn" style="background: #ef4444; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; display:none;">Clear Search</button>
                </div>
            </div>

            <!-- Ticket Table -->
            <div class="table-container">
                <table>
                    <thead>
                        <tr><th>Date</th><th>MRF No</th><th>Villa</th><th>System</th><th>Details</th><th>Status</th></tr>
                    </thead>
                    <tbody id="ticketTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- APP 2: COMPOUND -->
        <div id="app-compound" class="hidden">
            <!-- Sub-Nav -->
            <div style="background: white; padding: 10px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; gap: 10px;">
                    <button id="tabRenov" class="nav-tab active" onclick="switchCompoundTab('renovation')">Renovation Status</button>
                    <button id="tabAC" class="nav-tab" onclick="switchCompoundTab('ac')">AC Replacement</button>
                </div>
                <!-- EXPORT COMPOUND DATA -->
                <button onclick="exportCompoundData()" class="export-btn"><i class="fas fa-file-excel"></i> Export Data</button>
            </div>

            <!-- SEARCH BAR -->
            <div style="margin-bottom: 20px;">
                <input type="text" id="compoundSearch" placeholder="Search Villas..." onkeyup="handleCompoundSearch()" style="width: 100%; padding: 15px; border: 1px solid #ddd; border-radius: 10px; font-size: 1rem; outline: none;">
            </div>

            <!-- RENOVATION CONTENT -->
            <div id="viewRenovation">
                <!-- Stats -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="stat-card" style="border-left-color: #3b82f6;" onclick="filterRenov('all')"><div class="stat-icon" style="background:#3b82f6"><i class="fas fa-home"></i></div><div><h3 id="rTotal">0</h3><p>Total</p></div></div>
                    <div class="stat-card" style="border-left-color: #22c55e;" onclick="filterRenov('full')"><div class="stat-icon" style="background:#22c55e"><i class="fas fa-check"></i></div><div><h3 id="rFull">0</h3><p>Full</p></div></div>
                    <div class="stat-card" style="border-left-color: #a855f7;" onclick="filterRenov('half')"><div class="stat-icon" style="background:#a855f7"><i class="fas fa-adjust"></i></div><div><h3 id="rHalf">0</h3><p>Half</p></div></div>
                    <div class="stat-card" style="border-left-color: #eab308;" onclick="filterRenov('prog')"><div class="stat-icon" style="background:#eab308"><i class="fas fa-tools"></i></div><div><h3 id="rProg">0</h3><p>Progress</p></div></div>
                    <div class="stat-card" style="border-left-color: #ef4444;" onclick="filterRenov('non')"><div class="stat-icon" style="background:#ef4444"><i class="fas fa-times"></i></div><div><h3 id="rNon">0</h3><p>Non-Renovated</p></div></div>
                </div>

                <!-- View Toggle -->
                <div style="margin: 20px 0; display: flex; gap: 10px;">
                    <button onclick="toggleView('renov', 'table')" id="btnRenovTable" style="background: #1e3a5f; color: white; padding: 8px 15px; border: none; border-radius: 6px;">Table</button>
                    <button onclick="toggleView('renov', 'cards')" id="btnRenovCards" style="background: #e2e8f0; color: #333; padding: 8px 15px; border: none; border-radius: 6px;">Cards</button>
                </div>

                <!-- Renovation Data -->
                <div id="renovTableContainer" class="table-container"><table><thead><tr><th>Villa</th><th>Status</th><th>Cost</th><th>Duration</th><th>Date</th><th>Notes</th></tr></thead><tbody id="renovTableBody"></tbody></table></div>
                <div id="renovCardContainer" class="card-grid"></div>
            </div>

            <!-- AC CONTENT -->
            <div id="viewAC" class="hidden">
                 <!-- Stats -->
                 <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="stat-card" style="border-left-color: #3b82f6;" onclick="filterAC('all')"><div class="stat-icon" style="background:#3b82f6"><i class="fas fa-wind"></i></div><div><h3 id="aTotal">0</h3><p>Total ACs</p></div></div>
                    <div class="stat-card" style="border-left-color: #22c55e;" onclick="filterAC('new')"><div class="stat-icon" style="background:#22c55e"><i class="fas fa-plus"></i></div><div><h3 id="aNew">0</h3><p>New ACs</p></div></div>
                    <div class="stat-card" style="border-left-color: #eab308;" onclick="filterAC('old')"><div class="stat-icon" style="background:#eab308"><i class="fas fa-history"></i></div><div><h3 id="aOld">0</h3><p>Old ACs</p></div></div>
                </div>

                 <!-- View Toggle -->
                 <div style="margin: 20px 0; display: flex; gap: 10px;">
                    <button onclick="toggleView('ac', 'table')" id="btnACTable" style="background: #1e3a5f; color: white; padding: 8px 15px; border: none; border-radius: 6px;">Table</button>
                    <button onclick="toggleView('ac', 'cards')" id="btnACCards" style="background: #e2e8f0; color: #333; padding: 8px 15px; border: none; border-radius: 6px;">Cards</button>
                </div>

                <!-- AC Data -->
                <div id="acTableContainer" class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>VILLA</th>
                                <th>LIVING ROOM</th><th>SITTING</th><th>OFFICE</th>
                                <th>MASTER BEDROOM 1</th><th>MASTER BEDROOM 2</th><th>MASTER BEDROOM 3</th>
                                <th>KIDS ROOM</th><th>GUEST ROOM</th><th>KITCHEN</th>
                                <th>SQ (STORE)</th><th>STORE</th><th>PATIO</th>
                                <th>TOTAL QTY</th>
                            </tr>
                        </thead>
                        <tbody id="acTableBody"></tbody>
                    </table>
                </div>
                <div id="acCardContainer" class="card-grid"></div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIG ---
        const PASSWORD = 'villa2025';
        const SHEET_1 = '1T8p2ojn8W6jmC5rTAcZ7xxE7MKy-n9fa5ke4QFzVQY4';
        const SHEET_2 = '1NQguf6umaBIgBmPDu3EYqQXBW6Ovo6pcoTkalDSUlnk';
        
        // --- GLOBAL STATE ---
        let ticketYear = '2026';
        let allTickets = [];
        let ticketFilters = { mrf: '', villa: '', system: '', status: '', details: '' };
        
        let renovData = [];
        let acData = [];
        let compoundFilter = 'all';

        // --- INIT ---
        if(sessionStorage.getItem('auth') === 'true') showApp();

        // --- 1. EYE ICON FUNCTION ---
        function togglePasswordVisibility() {
            const passwordInput = document.getElementById('masterPassword');
            const toggleIcon = document.getElementById('togglePassword');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordInput.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            if(document.getElementById('masterPassword').value === PASSWORD) {
                sessionStorage.setItem('auth', 'true');
                showApp();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function showApp() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('master-nav').classList.remove('hidden');
            
            // Load Data
            initTickets();
            initCompound();
        }

        function logout() {
            sessionStorage.removeItem('auth');
            location.reload();
        }

        function switchMainTab(tab) {
            document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('app-tickets').classList.add('hidden');
            document.getElementById('app-compound').classList.add('hidden');
            
            document.getElementById(`app-${tab}`).classList.remove('hidden');
        }

        // ============================================
        // APP 1: TICKETS
        // ============================================
        const SHEETS_GIDS = {
            '2026': '878818171', '2025': '931447490', '2024': '17034059', '2023': '524434308',
            '2022': '174001593', '2021': '1182812429', '2020': '0', '2019': '260773250', '2018': '1420362351'
        };

        async function initTickets() {
            const select = document.getElementById('yearSelect');
            select.innerHTML = Object.keys(SHEETS_GIDS).sort((a,b)=>b.localeCompare(a)).map(y => `<option value="${y}">Year ${y}</option>`).join('');
            select.value = ticketYear;
            loadTicketData();
        }

        async function loadTicketData() {
            const tbody = document.getElementById('ticketTableBody');
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Loading...</td></tr>';
            
            try {
                const gid = SHEETS_GIDS[ticketYear];
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_1}/export?format=csv&gid=${gid}`;
                const res = await fetch(url);
                const csv = await res.text();
                const lines = csv.split('\n');
                
                allTickets = [];
                const systemSet = new Set(); 

                // Skip Header
                for(let i=1; i<lines.length; i++) {
                    const vals = parseCSV(lines[i]);
                    if(vals[2]) { // Has MRF
                        const system = vals[4] || 'Other';
                        allTickets.push({
                            date: vals[0], time: vals[1], mrf: vals[2], villa: vals[3], 
                            system: system, rec: vals[5], details: vals[6], intBy: vals[7],
                            actBy: vals[8], actDate: vals[9], status: vals[10] || 'Pending'
                        });
                        systemSet.add(system);
                    }
                }
                
                // Populate Dropdown
                const sysSelect = document.getElementById('systemInput');
                sysSelect.innerHTML = '<option value="">All Systems</option>' + 
                    Array.from(systemSet).sort().map(s => `<option value="${s}">${s}</option>`).join('');

                renderTicketSystemStats();
                renderTicketView();
            } catch(e) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:red;">Error Loading</td></tr>';
            }
        }

        function renderTicketSystemStats() {
            const pending = allTickets.filter(t => !t.status || t.status.toLowerCase().includes('pending'));
            const sysMap = {
                'AC': {c:'blue', i:'‚ùÑÔ∏è'}, 'Electrical': {c:'yellow', i:'‚ö°'}, 'Plumbing': {c:'cyan', i:'üö∞'},
                'Carpentry': {c:'gray', i:'üî®'}, 'Painting': {c:'purple', i:'üé®'}, 'Mason': {c:'green', i:'üß±'}
            };
            
            const html = Object.keys(sysMap).map(sys => {
                const count = pending.filter(t => t.system === sys).length;
                return `
                    <div class="stat-card sys-${sysMap[sys].c}" onclick="applySystemFilter('${sys}')">
                        <div class="stat-icon" style="background: #ccc; color: #555;">${sysMap[sys].i}</div>
                        <div>
                            <h3 style="margin:0; font-size:1.5rem;">${count}</h3>
                            <p style="margin:0; font-size:0.9rem;">${sys}</p>
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('systemGrid').innerHTML = html;
        }

        function applySystemFilter(sys) {
            document.getElementById('systemInput').value = sys;
            document.getElementById('statusInput').value = 'pending';
            applyTicketFilters();
        }

        function switchTicketYear(y) {
            ticketYear = y;
            document.getElementById('currentYearDisplay').innerText = y;
            resetTicketDashboard();
            loadTicketData();
        }

        function resetTicketDashboard() {
            ticketFilters = { mrf: '', villa: '', system: '', status: '', details: '' };
            document.getElementById('mrfInput').value = '';
            document.getElementById('villaInput').value = '';
            document.getElementById('systemInput').value = '';
            document.getElementById('statusInput').value = '';
            document.getElementById('detailsInput').value = '';
            document.getElementById('clearBtn').style.display = 'none';
            renderTicketView();
        }

        function applyTicketFilters() {
            ticketFilters.mrf = document.getElementById('mrfInput').value.trim();
            ticketFilters.villa = document.getElementById('villaInput').value.trim();
            ticketFilters.system = document.getElementById('systemInput').value;
            ticketFilters.status = document.getElementById('statusInput').value;
            ticketFilters.details = document.getElementById('detailsInput').value.trim();
            document.getElementById('clearBtn').style.display = 'block';
            renderTicketView();
        }

        function renderTicketView() {
            const f = ticketFilters;
            const filtered = allTickets.filter(t => {
                return (!f.mrf || t.mrf.toLowerCase().includes(f.mrf.toLowerCase())) &&
                       (!f.villa || t.villa.toLowerCase().includes(f.villa.toLowerCase())) &&
                       (!f.system || t.system === f.system) &&
                       (!f.status || t.status.toLowerCase().includes(f.status.toLowerCase())) &&
                       (!f.details || t.details.toLowerCase().includes(f.details.toLowerCase()));
            });

            // Update Top Stats based on Filter
            const stats = {
                t: filtered.length, p: filtered.filter(x=>x.status.toLowerCase().includes('pending')).length,
                c: filtered.filter(x=>x.status.toLowerCase().includes('completed')).length,
                pr: filtered.filter(x=>x.status.toLowerCase().includes('progress')).length
            };
            
            document.getElementById('ticketStatsArea').innerHTML = `
                <div class="stat-card" style="border-left-color:#3b82f6"><div class="stat-icon" style="background:#3b82f6">T</div><div><h3>${stats.t}</h3><p>Total</p></div></div>
                <div class="stat-card" style="border-left-color:#eab308"><div class="stat-icon" style="background:#eab308">P</div><div><h3>${stats.p}</h3><p>Pending</p></div></div>
                <div class="stat-card" style="border-left-color:#4f46e5"><div class="stat-icon" style="background:#4f46e5">I</div><div><h3>${stats.pr}</h3><p>In Progress</p></div></div>
                <div class="stat-card" style="border-left-color:#22c55e"><div class="stat-icon" style="background:#22c55e">C</div><div><h3>${stats.c}</h3><p>Completed</p></div></div>
            `;

            // Table
            const tbody = document.getElementById('ticketTableBody');
            
            // --- MODIFICATION: SHOW ONLY LAST 10 TICKETS ON HOME ---
            let displayData = filtered;
            const isSearching = f.mrf || f.villa || f.system || f.status || f.details;
            
            if (!isSearching) {
                // Reverse to get newest first, then take last 10
                displayData = [...filtered].reverse().slice(0, 10);
            } else {
                // If searching, show all results (up to a limit for performance, e.g. 100)
                displayData = [...filtered].reverse().slice(0, 100);
            }

            if(displayData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No tickets found</td></tr>';
            } else {
                tbody.innerHTML = displayData.map(t => `
                    <tr>
                        <td>${t.date}</td>
                        <td style="font-weight:bold; color:#3b82f6;">${t.mrf}</td>
                        <td>${t.villa}</td>
                        <td><span style="background:#eff6ff; color:#1e40af; padding:2px 8px; border-radius:4px; font-size:0.8rem;">${t.system}</span></td>
                        <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${t.details}</td>
                        <td><span class="badge ${getBadge(t.status)}">${t.status}</span></td>
                    </tr>
                `).join('');
            }
        }

        function getBadge(s) {
            if(s.toLowerCase().includes('completed')) return 'badge-completed';
            if(s.toLowerCase().includes('progress')) return 'badge-progress';
            return 'badge-pending';
        }

        // --- EXPORT FUNCTION FOR TICKETS ---
        function exportTicketData() {
            const ws = XLSX.utils.json_to_sheet(allTickets.map(t => ({
                Date: t.date, Time: t.time, 'MRF No': t.mrf, Villa: t.villa, 
                System: t.system, Details: t.details, Status: t.status
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tickets");
            XLSX.writeFile(wb, `Maintenance_Report_${ticketYear}.xlsx`);
        }

        // ============================================
        // APP 2: COMPOUND
        // ============================================
        async function initCompound() {
            try {
                await Promise.all([fetchRenov(), fetchAC()]);
                renderCompound();
            } catch(e) { console.error(e); }
        }

        async function fetchRenov() {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_2}/gviz/tq?tqx=out:json&gid=0`);
            const txt = await res.text();
            const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
            renovData = json.table.rows.map((r,i) => {
                const c = r.c;
                return { 
                    id: i, v: getVal(c,0), s: getVal(c,1), dR: getVal(c,2), rem: getVal(c,3), 
                    cost: parseFloat(String(getVal(c,4)).replace(/[^0-9.-]/g,''))||0, sD: getVal(c,5), eD: getVal(c,6), n: getVal(c,7)
                };
            }).filter(x => x.v && !String(x.v).toLowerCase().includes('villa'));
        }

        async function fetchAC() {
            const res = await fetch(`https://docs.google.com/spreadsheets/d/${SHEET_2}/gviz/tq?tqx=out:json&gid=7537460`);
            const txt = await res.text();
            const json = JSON.parse(txt.substring(txt.indexOf('{'), txt.lastIndexOf('}')+1));
            acData = json.table.rows.map((r,i) => {
                const c = r.c;
                return {
                    id: i, v: getVal(c,0), l: getVal(c,1), si: getVal(c,2), o: getVal(c,3), m1: getVal(c,4),
                    m2: getVal(c,5), m3: getVal(c,6), k: getVal(c,7), g: getVal(c,8), ki: getVal(c,9), sq: getVal(c,10), st: getVal(c,11), p: getVal(c,12)
                };
            }).filter(x => x.v && !String(x.v).toLowerCase().includes('villa'));
        }

        function renderCompound() {
            // Renov Stats
            document.getElementById('rTotal').innerText = renovData.length;
            document.getElementById('rFull').innerText = renovData.filter(x=>isRenov(x.s,'full')).length;
            document.getElementById('rHalf').innerText = renovData.filter(x=>isRenov(x.s,'half')).length;
            document.getElementById('rProg').innerText = renovData.filter(x=>isRenov(x.s,'prog')).length;
            document.getElementById('rNon').innerText = renovData.filter(x=>isRenov(x.s,'non')).length;

            // AC Stats
            let tAc=0, nAc=0, oAc=0;
            acData.forEach(d => {
                [d.l,d.si,d.o,d.m1,d.m2,d.m3,d.k,d.g,d.ki,d.sq,d.st,d.p].forEach(v => {
                    const s = String(v).toUpperCase();
                    if(s && s!=='X') { tAc++; if(s.includes('NEW')) nAc++; else oAc++; }
                });
            });
            document.getElementById('aTotal').innerText = tAc;
            document.getElementById('aNew').innerText = nAc;
            document.getElementById('aOld').innerText = oAc;

            renderRenovTable();
            renderRenovCards();
            renderACTable();
            renderACCards();
        }

        function switchCompoundTab(t) {
            document.getElementById('tabRenov').classList.toggle('active', t==='renovation');
            document.getElementById('tabAC').classList.toggle('active', t==='ac');
            document.getElementById('viewRenovation').classList.toggle('hidden', t!=='renovation');
            document.getElementById('viewAC').classList.toggle('hidden', t!=='ac');
        }

        function toggleView(type, v) {
            if(type==='renov') {
                document.getElementById('renovTableContainer').classList.toggle('hidden', v!=='table');
                document.getElementById('renovCardContainer').classList.toggle('hidden', v!=='cards');
                document.getElementById('btnRenovTable').style.background = v==='table'?'#1e3a5f':'#e2e8f0';
                document.getElementById('btnRenovTable').style.color = v==='table'?'white':'#333';
                document.getElementById('btnRenovCards').style.background = v==='cards'?'#1e3a5f':'#e2e8f0';
                document.getElementById('btnRenovCards').style.color = v==='cards'?'white':'#333';
            } else {
                document.getElementById('acTableContainer').classList.toggle('hidden', v!=='table');
                document.getElementById('acCardContainer').classList.toggle('hidden', v!=='cards');
                document.getElementById('btnACTable').style.background = v==='table'?'#1e3a5f':'#e2e8f0';
                document.getElementById('btnACTable').style.color = v==='table'?'white':'#333';
                document.getElementById('btnACCards').style.background = v==='cards'?'#1e3a5f':'#e2e8f0';
                document.getElementById('btnACCards').style.color = v==='cards'?'white':'#333';
            }
        }

        function filterRenov(type) {
            compoundFilter = 'r'+type;
            renderRenovTable();
            renderRenovCards();
        }

        function filterAC(type) {
            compoundFilter = 'a'+type;
            renderACTable();
            renderACCards();
        }

        // Render Renovation
        function renderRenovTable() {
            let data = renovData;
            if(compoundFilter === 'rfull') data = renovData.filter(x=>isRenov(x.s,'full'));
            else if(compoundFilter === 'rhalf') data = renovData.filter(x=>isRenov(x.s,'half'));
            else if(compoundFilter === 'rprog') data = renovData.filter(x=>isRenov(x.s,'prog'));
            else if(compoundFilter === 'rnon') data = renovData.filter(x=>isRenov(x.s,'non'));

            document.getElementById('renovTableBody').innerHTML = data.map(x => `
                <tr>
                    <td>Villa ${x.v}</td>
                    <td><span class="badge ${getRenovBadge(x.s)}">${x.s||'N/A'}</span></td>
                    <td>${x.cost}</td>
                    <td>${calcDur(x.sD, x.eD)} days</td>
                    <td>${x.dR||'-'}</td>
                    <td>${x.n||'-'}</td>
                </tr>
            `).join('');
        }

        function renderRenovCards() {
             let data = renovData;
            if(compoundFilter === 'rfull') data = renovData.filter(x=>isRenov(x.s,'full'));
            else if(compoundFilter === 'rhalf') data = renovData.filter(x=>isRenov(x.s,'half'));
            else if(compoundFilter === 'rprog') data = renovData.filter(x=>isRenov(x.s,'prog'));
            else if(compoundFilter === 'rnon') data = renovData.filter(x=>isRenov(x.s,'non'));

            document.getElementById('renovCardContainer').innerHTML = data.map(x => `
                <div class="villa-card">
                    <div class="card-header" style="background:${getRenovColor(x.s)}">Villa ${x.v}</div>
                    <div class="card-body">
                        <div class="card-row"><span>Status:</span><b>${x.s}</b></div>
                        <div class="card-row"><span>Cost:</span><b>${x.cost}</b></div>
                        <div class="card-row"><span>Duration:</span><b>${calcDur(x.sD, x.eD)} days</b></div>
                        <div class="card-row"><span>Notes:</span><span>${x.n||'-'}</span></div>
                    </div>
                </div>
            `).join('');
        }

        // Render AC
        function renderACTable() {
            let data = acData;
            if(compoundFilter === 'anew') data = acData.filter(x => hasACType(x, 'NEW'));
            else if(compoundFilter === 'aold') data = acData.filter(x => hasACType(x, 'OLD'));

            document.getElementById('acTableBody').innerHTML = data.map(x => `
                <tr>
                    <td>Villa ${x.v}</td>
                    ${renderCell(x.l)}${renderCell(x.si)}${renderCell(x.o)}
                    ${renderCell(x.m1)}${renderCell(x.m2)}${renderCell(x.m3)}
                    ${renderCell(x.k)}${renderCell(x.g)}${renderCell(x.ki)}
                    ${renderCell(x.sq)}${renderCell(x.st)}${renderCell(x.p)}
                    <td style="text-align:center; font-weight:bold;">${getTotalAC(x)}</td>
                </tr>
            `).join('');
        }

        function renderACCards() {
            let data = acData;
            if(compoundFilter === 'anew') data = acData.filter(x => hasACType(x, 'NEW'));
            else if(compoundFilter === 'aold') data = acData.filter(x => hasACType(x, 'OLD'));

            document.getElementById('acCardContainer').innerHTML = data.map(x => `
                <div class="villa-card">
                    <div class="card-header" style="background:#0ea5e9">Villa ${x.v}</div>
                    <div class="card-body">
                        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px; text-align:center;">
                            ${renderRoomCard('LIVING ROOM', x.l)}${renderRoomCard('SITTING', x.si)}${renderRoomCard('OFFICE', x.o)}
                            ${renderRoomCard('MASTER BEDROOM 1', x.m1)}${renderRoomCard('MASTER BEDROOM 2', x.m2)}${renderRoomCard('MASTER BEDROOM 3', x.m3)}
                            ${renderRoomCard('KIDS ROOM', x.k)}${renderRoomCard('GUEST ROOM', x.g)}${renderRoomCard('KITCHEN', x.ki)}
                            ${renderRoomCard('SQ (STORE)', x.sq)}${renderRoomCard('STORE', x.st)}${renderRoomCard('PATIO', x.p)}
                        </div>
                        <div style="margin-top:15px; text-align:right; font-weight:bold; border-top:1px solid #eee; padding-top:10px;">Total: ${getTotalAC(x)}</div>
                    </div>
                </div>
            `).join('');
        }

        // --- EXPORT FUNCTION FOR COMPOUND ---
        function exportCompoundData() {
            const ws1 = XLSX.utils.json_to_sheet(renovData.map(x => ({
                'Villa No': x.v, 'Status': x.s, 'Cost': x.cost, 'Duration (Days)': calcDur(x.sD, x.eD), 'Notes': x.n
            })));
            const ws2 = XLSX.utils.json_to_sheet(acData.map(x => ({
                'Villa No': x.v, 'Living Room': x.l, 'Sitting': x.si, 'Office': x.o,
                'Master 1': x.m1, 'Master 2': x.m2, 'Master 3': x.m3, 'Kids': x.k,
                'Guest': x.g, 'Kitchen': x.ki, 'SQ': x.sq, 'Store': x.st, 'Patio': x.p,
                'Total ACs': getTotalAC(x)
            })));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws1, "Renovation");
            XLSX.utils.book_append_sheet(wb, ws2, "AC Replacement");
            XLSX.writeFile(wb, `Compound_Report_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // Helpers
        function getVal(c,i) { if(!c||!c[i]) return ''; return c[i].f||c[i].v||''; }
        function parseCSV(l) { const v=[]; let c='', q=false; for(let ch of l){ if(ch==='"') q=!q; else if(ch===','&&!q) { v.push(c.trim().replace(/^"|"$/g,'')); c=''; } else c+=ch; } v.push(c.trim().replace(/^"|"$/g,'')); return v; }
        function isRenov(s,t) { s=String(s).toLowerCase(); if(t==='full') return s.includes('full')||s.includes('renovated')&&!s.includes('half')&&!s.includes('under'); if(t==='half') return s.includes('half'); if(t==='prog') return s.includes('under')||s.includes('progress'); return !isRenov(s,'full')&&!isRenov(s,'half')&&!isRenov(s,'prog'); }
        function getRenovBadge(s) { if(isRenov(s,'full')) return 'badge-completed'; if(isRenov(s,'prog')) return 'badge-progress'; if(isRenov(s,'half')) return 'badge-pending'; return 'badge-pending'; }
        function getRenovColor(s) { if(isRenov(s,'full')) return '#22c55e'; if(isRenov(s,'prog')) return '#eab308'; if(isRenov(s,'half')) return '#a855f7'; return '#ef4444'; }
        function calcDur(s,e) { if(!s) return 0; return Math.ceil((new Date(e||new Date())-new Date(s))/(86400000)); }
        function renderCell(val) { const s=String(val).toUpperCase(); const c=s.includes('NEW')?'#22c55e':(s.includes('OLD')?'#eab308':'#94a3b8'); return `<td style="text-align:center; color:${c}; font-weight:bold;">${val}</td>`; }
        function renderRoomCard(name, val) { 
            const s = String(val).toUpperCase(); 
            const c = s.includes('NEW')?'#22c55e':(s.includes('OLD')?'#eab308':'#94a3b8'); 
            return `
            <div style="background:#f8fafc; padding:8px; border-radius:6px; border:1px solid #e2e8f0;">
                <div style="font-size:0.7rem; color:#64748b; font-weight:bold; margin-bottom:2px;">${name}</div>
                <div style="font-size:0.9rem; font-weight:bold; color:${c}">${val}</div>
            </div>`; 
        }
        function getTotalAC(x) { return [x.l,x.si,x.o,x.m1,x.m2,x.m3,x.k,x.g,x.ki,x.sq,x.st,x.p].filter(v=>v&&v!=='X').length; }
        function hasACType(x, type) { return [x.l,x.si,x.o,x.m1,x.m2,x.m3,x.k,x.g,x.ki,x.sq,x.st,x.p].some(v=>String(v).toUpperCase().includes(type)); }
        function handleCompoundSearch() {
            const q = document.getElementById('compoundSearch').value.toLowerCase();
            document.querySelectorAll('#renovTableBody tr, #acTableBody tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(q)?'':'none');
            document.querySelectorAll('.villa-card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(q)?'block':'none');
        }
    </script>
</body>
</html>
